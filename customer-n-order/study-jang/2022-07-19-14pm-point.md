<div style="text-align: right"> 2022.07.19 14:00 PM </div>

# 적립금 설명

1. 필요한 api는 core cnPnmController에 위치

## 고객적립금(TB_CU_CUST_PNM)
1. 원고객적립금ID
    - 사용(차감)했을 때 어디서 사용했는지 얼마나 사용했는지 찾을 수 있음
2. 적립금상태코드 (PNM_STS_CD): (등록/정상)
3. 적립금증감사유코드 (PNM_IAD_RSN_CD): (상품구매/이벤트적립/출석체크/상품구매/이벤트응모/임의부여/소멸)
4. 유효기간코드 (PNM_VLD_DUR_CD): (7일/30일/90일/180일/365일)
5. 적립사유구분코드(PNM_RSN_TYP_CD)
    - 코드 따로 없음
    - PNM_RLTD_TYP_CD (적립금관련구분코드) : (주문/취소/교환/반품/이벤트/임의부여/소멸)
    - **컬럼명 바꿀 필요 있음**
6. 적립금증감사유코드-적립금사유구분코드 사용 예시
7. 적립금 순번은 차감 시 사용
    - **빼는 게 나을 것 같다는 의견이 있었음**
8. 조정/승인은 강제부여/임의부여/강제회수 시 들어감
    - 등록 시 조정자ID, 조정일시
    - 승인 시 승인자ID, 승인일시
    - 유효코드에 맞게 유효기간 설정해서 update
9. 화면 설명
    1. 고객 적립금 조회: 고객 적립금 내역을 조회
        - 사용가능한 금액은 Mall, 주문서에 보임
    2. 고객 적립금 강제부여
        - 고객 적립금 강제 부여된 것만 조회됨

## 고객적립금 회수 모듈
1. **마이너스 적립금 고려 없이 설계 됨**
2. 부족한 적립금은 결제 금액에서 차감
    - 고객사 판단사항이나 웬만하면 환불금액을 다 돌려주는 방향으로 진행됨
    - 마이너스 적립금 고려가 필요할 수도 있고 그러면 로직 전반적으로 수정해야 할 수도 있음
    - 마이너스 적립금은 고객에게도 마이너스 값으로 보여짐 (당분간 적립 없다)

## 고객적립금 사용 기준
1. 쌓여있는 적립금의 차감순서
2. 유효기간이 얼마 안 남은 적립금, 금액이 적은 적립금 순
3. 사용가능한 적립금은 원 적립금 금액을 기준으로 차감하여 insert -????
4. 0원이 될 때까지 작업

## 주문 접수 시 적립금 사용 모듈
1. DB보단 WAS에서 부담을
2. SELECT를 두 번 하는 것보다 한 번만에 처리하는 게 낫다

## 고객 적립금 원복 모듈
1. **수정 필요**
2. 원복 기준은 사용 기준 순서의 반대 (**순서 재확인 필요**)
3. **원복 기준이 되는 원 적립금 재확인 및 수정 필요**
    - 100,000원 구매하여 5000원 적립 - 적립금 A
    - 6,000원 구매 중 4,000원 사용 - 적립금 A 4,000원 차감
    - 3,000원 구매 중 1,500원 사용 - 적립금 A 1,000원 차감 + B 500원 차감
    - 3,000원 환불 시 적립금 A에 1,000원 원복해주는 방향으로 지금 순서도에 그려짐 -> **수정**

## 회수 완료 시 적립금 증감 모듈
1. 마이너스 적립금이 고려하지 않고 만듦
2. 주문으로 인해 부여된 적립금 중 유효기간이 만료(소멸)되었거나 강제 회수된 적립금은 회수 안 한다.
    - 회수 시 사용한 적립금만큼 신용카드에서 차감하여 환불, 적립금 원복
3. 환불 승인 때도 호출하는 모듈 임
    - 환불 시점에서 호출
4. 미리 회수된 적립금은 돌려준다?
5. **반품 시 적립금 회수와 환불 중 무엇이 선행되는지 확인 필요**
6. 적립금은 회사에 채무로 나타나기 때문에 안 남기는 것을 더 선호

## 고객적립금 회수 모듈
1. **마이너스 적립금 고려 없이 설계 됨**
2. 부족한 적립금은 결제 금액에서 차감
    - 고객사 판단사항이나 웬만하면 환불금액을 다 돌려주는 방향으로 진행됨
    - 마이너스 적립금 고려가 필요할 수도 있고 그러면 로직 전반적으로 수정해야 할 수도 있음
    - 마이너스 적립금은 고객에게도 마이너스 값으로 보여짐 (당분간 적립 없다)
    - 적립금은 회사에 채무로 나타나기 때문에 안 남기는 것을 더 선호
3. 남아있는 적립금에서 차감하여 회수
4. 환불할 때 차감할 적립금보다 보유한 적립금 금액이 적을 시 exception을 발생하여 실행이 아예 안됨
    - **모자라는 금액을 return해서 카드결제금액에서 차감하고 적립금은 0원으로 update하는 것으로 수정해야함**

## 환불관련 적립금 정보 조회
1. 객체 1개일 때를 기준으로 하여 바깥에서 loop 돌려야 함
2. 목록의 sum이 아니고 객체 1개 기준

## 주문적립금이력(TB_OD_ORD_PNM_HSR)
1. batch가 바라보는 테이블
    - 적립금액, 적립금액최종등록일시로 batch가 돈 걸 알 수 있음
2. batch가 돌기 전 주문 취소
    - 적립금액 0원
    - 적립금액최종등록일시 SYSDATE
3. 주문완료
    - 적립금액 update
    - 적립금액최종등록일시 update
4. **회수확정하면 바로 적립금 부여(회수) 하는 방식**
    - **반품 때도 주문ID, 반품상품ID, 최종등록일시 SYSDATE update** 변경
        - 반품 취소는 상태값이 다르기 때문에 상관 없음
