# 주문상품과 취소 교환 반품


## 주문상품(TB_OD_ORD_GDS)


|상품|주문ID|주문순번|메인상품여부|사은품포함여부|사은품여부|메인상품주문순번|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|A|1|1|Y|Y|N|NULL|
|B|1|2|N|Y|Y|1|
|C|1|3|Y|Y|N|NULL|
|D|1|4|N|N|Y|3|

1. 메인상품여부 Y
    - 사은품을 포함하고 있는 일반상품과 일반적으로 주문하는 일반상품
    - Q. 사은품여부는 상품구분코드와 상품유형코드를 확인하여 서비스에서 판단하는지

2. 메인상품주문순번은 메인상품에 딸린 그룹의 메인상품의 주문 순번

3. 사은품프로모션ID 는 시스템 프로모션ID로 정산을 위한 데이터
    - 주문 당시의 프로모션 정보를 세팅
4. 사은품사유코드는 인위적인 입력값
    - **Q. 코드값 존재하지 않음**
    - 프로모션 사은품으로 있지 않고 주문 생성 이후 고객 클레임 대응으로 MD가 임의로 줄 수도 있을 때 사용
        - Q. 이 경우 로직 처리 어떻게 하는지
5. 출고 및 배송과 관련된 일시는 주문상태코드와 연관지어 생각해야 함
6. 결제 완료 시 출고일시, 배송예정일시 세팅
    - 출고지시일시 = 주문접수일시 + 1일
    - 배송예정일시 = 상품M의 배송소요기간 + 주문접수일시
    - 평균배송소요기간은 상품M의 배송소요기간
7. 배송준비일시: 협력사가 SCM에서 주문내역을 다운로드할 때
8. 배송시작일시: 협력사가 운송장 등록
9. 배송완료일시: 운송 업체에서 받은 배송완료일시 정보
10. 배송사배송완료일시: 운송 업체에서 받은 배송사의 배송완료일시 정보
11. 매출확정일시: 매출확정일시는 보통 배송완료일시와 같은 일시가 저장되나 고객사요구사항에 따라 달라질 수 있음
    - 예) 고객사에서 매출일시에 주말 제외를 요구할 시
12. 업무상 배송완료일시를 강제 update시킬 수도 있음
    - 예) 롯데ON 사례 - 상품 크록스
        - 상품이 입고도 안된 상태에서 판매자가 먼저 배송준비중 -> 배송중으로 변경 가능
        - 운송장도 없음
        - 소비자가 배송지연으로 인한 주문 취소 요구 그러나 주문상태가 이미 배송중이므로 반품만 가능
        - 이 경우는 판매자가 직접 배송완료(운송장 안 나왔어도), 반품 접수, 반품승인까지 처리
    - 적립금 batch 고려
13. 배송수량
    - 당사의 운송장 관리의 경우 직접 관리가 가능하므로 운송장 여러 개를 등록할 수 있음
        - 배송수량 update 도 가능
        - 배송수량 == 주문수량일 때 배송완료 처리 가능
14. 취소수량, 반품접수수량
    - 취소/반품유효수량 = 주문수량 - 취소수량 - 반품접수수량
        - 부분취소 및 주문 상태 고려 필요
    - 주문 취소는 철회 불가능
        - 매출 미반영 상태
        - 다시 주문해야 하는 게 더 편리
    - 반품 취소는 철회 가능
        - 반품접수수량 update 필요
        - 매출 반영 후이기 때문에 철회 시 이득
15. 선환불대상여부
    - 선환불이 가능할 때 이 상품을 선환불 해줄지
    - 고객이 클레임할 경우 선환불해줘야 할 수도 있음
    - Q. 선환불대상여부 상품M에 추가되어야 하는지
16. 환불구분코드
    - (선환불/후환불)
    - 회수완료 전 환불 / 회수완료 및 검수 후 환불


* Q. 배송지 변경 시 추가 주문 배송비
    - 도서산간 or 제주도로 변경
        - 정책에 따라 다름
    - 결제테이블, 배송비테이블 연관
    - 결제그룹ID와 연관되는지

* Q. 사은품_회수_필요_여부
    - 상품M에 사은품회수여부 혹은 사은품회수필수여부 없음

## 취소 교환 반품

1. 주문 TEMP 테이블 없음
2. 쿠폰 및 프로모션 정보와 적용된 상품 정보는 화면에서 들고 있고 DB까지는 반영이 되지 않음
    - 비회원/회원 여부로는 결제 정보가 달라서 서버단에서 데이터를 넣어줌
3. 결제 승인 완료 후 DB 데이터 생성(할인이력, 적립금이력)
* Q. 할인 적용 순서 기준(프로모션>쿠폰 순?)
4. 할인금액은 합계가 * 할인율임 (합계가는 단위판매가 * 주문수량)
5. 주문상품 테이블은 배송비ID 갖고 있음

### 결제와 환불
    - 결제와 환불 테이블의 금액 이동 주의 필요
1. 주문취소는 상품단위로 전체 수량 취소만 가능함
    - 수량 일부 취소 불가능
    - Q. 그럼 취소수량을 아예 안 받는지
2. 주문 -> 카드승인
    - 카드승인정보는 TB_SC_CRCD_APRV
    - (TB_OD_STLM) 결제수단관련ID로 TB_SC_CRCD_APRV의 PK 들어감
        - 적립금 결제 시 차감하는 고객적립금ID
    - (TB_SC_CRCD_APRV) 계좌소유자명, 가상계좌번호, 입금은행코드, 예금주명, 송금인명
        - 카드 대금 기간 지나갔을 때 결제 취소 카드승인 및 환불이 바로 안 되는 문제로 고객이 클레임 들어올 시 계좌이체로 안내해줌
        - Q. 이 경우 결제/환불 테이블에 환불제외금액 insert/update 되는지
3. 결제 성공 후
    - (TB_OD_STLM) 결제금액 == 환불가능금액
4. 주문 취소 혹은 반품 시
    - (TB_OD_STLM) (회수완료 이전일 때) 환불예정금액 update
5. 결제금액 = 환불가능금액 + 환불예정금액 + 환불제외금액 + 환불금액
6. 주문결제ID 최초생성 시 결제그룹ID는 무조건 1로 하드코딩되는지 확인하기
    - **결제수단 바꾸기 위한 재결제 시 결제그룹ID는 1로 들어가야 하는지 재확인 필요**
7. 취소 테이블은 환불정보 일치를 위해 테이블을 분리함 (취소그룹ID도 환불 테이블에 같이 추가됨)
    - Q. 취소테이블의 경우 거의 insert만 일어나게 되는데 나중에 주문 취소 상품 장바구니에 다시 추가하기 이런 기능 제공할 수도 있는지
8. (TB_OD_STLM) 의 결제예정금액은 무통장입금 관련

### 취소
|상품|수량|합계가|취소1|취소2|
|:---:|:---:|:---:|:---:|:---:|
|오렌지|2|2,0000|V|||
|사과|2|3,0000|V||
|배|2|5,0000||V|
|취소그룹ID|||1|2|
1. 취소 시
    - 결제 테이블 update
    - 환불 테이블 insert

### 반품
1. 반품 접수 -> 환불예정금액 update -> 카드취소 승인
    - 반품수량 == 회수수량일 시 (같은 반품그룹 내 상품이 모두 회수 완료되었을 때)
        - 회수확정 처리 가능
        - 카드취소 승인 성공 시 결제 테이블 update, 환불테이블 insert
            - Q. 결제테이블과 환불테이블 환불예정금액 용도
            - Q. 환불예정금액도 무통장입금이랑 관련되어 있는지
2. 반품 접수 시 반품접수수량 update
3. 반품 철회 시 반품접수수량 update
4. 한 주문에 같은 단품을 1개씩 여러 개 주문했을 시
    - 주문ID, 주문순번으로 구분
5. 연속적으로 교환하고 반품하는 경우
    - (A 상품 B로 교환 -> B 상품 C로 교환 -> C 상품 D로 교환 -> D 상품 반품)
    - 원주문순번은 직전교환 상품의 주문 순번 (A의 주문순번)
    - 교환이 연속적으로 이뤄져도 원주문순번이 계속 유지됨
        * 상이 교환은 잘 안 한다.

## 배송비
    - 배송비 모듈에 따름
        - 고려사항: 배송템플릿ID, 합포장여부, 무료배송여부(+무료배송기준금액)

|주문ID|주문상품ID|상품명|협력사ID|배송템플릿ID|합포장가능여부|개별배송비   |배송비ID|배송비    |
|:----:|:-------:|------|:-----:|:---------:|:-----------:|------------|:-----:|----------|
|1     |1        |A     |1      |1          |Y            |1,000       |1      |1,000     |
|1     |2        |B     |1      |1          |Y            |1,000       |1      |A와 합포장|
|1     |3        |D     |1      |2          |N            |3,000       |2      |6,000    |
|1     |4        |E     |1      |2          |N            |3,000       |2      |위와 동일 |
|1     |5        |F     |2      |3          |Y            |5,000       |3      |5,000    |

1. 같은 배송템플릿ID를 가지고 있는 상품 A (배송비 1,000원), B (배송비 1,000원), C (배송비 1,000원)
    - 배송비 테이블 row 1개
        - 합포장 여부 Y
            - A, B, C 배송비 통틀어 1,000원
        - 합포장 여부 N
            - A, B, C의 배송비를 각각 더함
                - 1,000 + 1,000 + 1,000 = 3,000원
2. 각각 다른 배송템플릿ID를 가지고 있는 상품 X (배송비 1,000원), Y (배송비 1,000원), Z (배송비 3,000원)
    - 배송비 테이블 row 3개
        - 배송비1: 1,000원
        - 배송비2: 1,000원
        - 배송비3: 3,000원

3. 반품배송비도 배송비 모듈에 따름
    - 반품할 상품들의 배송템플릿, 합포장여부 고려 (무료배송비도 있는 경우 함께 고려)

## 주문 시 재고차감
1. TB_PD_UNT 재고 수량 차감
    - update 로 인한 locking 고려